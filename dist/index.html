<!doctype html>
<html lang="en">
<head>
  <title>Field Guide — DIY Commune</title>
  <!-- components/layout/head.html -->
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="assets/css/guide.css">

  <style>
    .hud{position:absolute; left:16px; top:16px; right:16px; display:flex; gap:12px; align-items:flex-start; justify-content:space-between; pointer-events:none;}
    .panel{pointer-events:auto; max-width:min(720px,92vw);}
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <svg class="bg" id="bg" viewBox="0 0 1400 900" preserveAspectRatio="xMidYMid slice" aria-label="Field guide map">
  <defs>
    <pattern id="grid" width="80" height="80" patternUnits="userSpaceOnUse">
      <path d="M80 0H0V80" fill="none" stroke="var(--grid1)" stroke-width="2"/>
      <path d="M40 0V80M0 40H80" fill="none" stroke="var(--grid2)" stroke-width="2"/>
    </pattern>
    <filter id="grime" x="-20%" y="-20%" width="140%" height="140%">
      <feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="4" stitchTiles="stitch" result="n"/>
      <feColorMatrix in="n" type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 .55 0" result="n2"/>
      <feGaussianBlur stdDeviation="0.6" result="b"/>
      <feBlend in="SourceGraphic" in2="b" mode="multiply"/>
      <feBlend in="SourceGraphic" in2="n2" mode="overlay"/>
    </filter>
    <radialGradient id="vig" cx="50%" cy="45%" r="75%">
      <stop offset="0%" stop-color="rgba(0,0,0,0)"/>
      <stop offset="70%" stop-color="rgba(0,0,0,0.25)"/>
      <stop offset="100%" stop-color="rgba(0,0,0,0.55)"/>
    </radialGradient>
    <filter id="chalk" x="-30%" y="-30%" width="160%" height="160%">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch" result="t"/>
      <feDisplacementMap in="SourceGraphic" in2="t" scale="1.2"/>
      <feGaussianBlur stdDeviation="0.3"/>
    </filter>
    <filter id="hotGlow" x="-40%" y="-40%" width="180%" height="180%">
      <feGaussianBlur stdDeviation="4" result="b"/>
      <feColorMatrix in="b" type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 .7 0" result="b2"/>
      <feMerge><feMergeNode in="b2"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <style>
      .ink{fill:rgba(235,231,223,.92); font-family: ui-monospace, monospace;}
      .mark{stroke:rgba(235,231,223,.75); stroke-width:3; fill:none; stroke-linecap:round; stroke-linejoin:round; filter:url(#chalk);}
      .stamp{fill:rgba(214,181,91,.85); font-weight:900; letter-spacing:.06em;}
      .haz{fill:none; stroke:rgba(214,181,91,.35); stroke-width:10; stroke-dasharray:28 18; opacity:.7;}
      .ghost{fill:rgba(235,231,223,.55); font-family: ui-monospace, monospace;}
      .hot{cursor:pointer;}
      .label{opacity:.9; font-size:18px;}
      .ring{opacity:.85;}
      .hot:hover .ring{opacity:1;}
      .hot:hover .label{opacity:1;}
    </style>
  </defs>

  <rect width="1400" height="900" fill="var(--paper)"/>
  <rect width="1400" height="900" fill="var(--paper2)" opacity=".35"/>
  <rect width="1400" height="900" fill="url(#grid)" opacity=".85"/>
  <path class="haz" d="M80 82 H1320"/>
  <path class="haz" d="M80 828 H1320"/>

  <text x="92" y="105" class="stamp" font-size="18">FIELD GUIDE — DIY COMMUNE</text>
  <text x="92" y="150" class="ink" font-size="34" font-weight="900">MAP — CARE + CONTAINMENT</text>
  <text x="92" y="178" class="ghost" font-size="14">drag to pan · scroll to zoom · click CH markers</text>
  <path class="mark" d="M92 194 C320 182, 640 182, 920 192" opacity=".7"/>
  <text x="92" y="228" class="ghost" font-size="13">One is luck. Two is pattern. Three is policy.</text>

  <g id="hotspots"></g>

  <rect width="1400" height="900" fill="url(#vig)"/>
  <g filter="url(#grime)"><rect width="1400" height="900" fill="rgba(255,255,255,.001)"/></g>
</svg>


    <div class="hud">
      <div class="pill panel">
        <h1 class="title">Field Medic Ledger (DIY Commune)</h1>
        <p class="sub">Map → click a chapter marker. Drag to pan. Scroll to zoom.</p>
        <p class="sub small">Keys: <span class="k">R</span> reset view</p>
      </div>
      <div class="pill controls" style="pointer-events:auto">
        <a class="btn" href="chapter-1.html">Start →</a>
        <a class="btn" href="concept.html">Concept Docs →</a>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script src="assets/js/panzoom.js"></script>
  <script src="assets/js/guide.js"></script>
  <script>
    async function loadManifest(){
      const r = await fetch('manifest.json', {cache:'no-store'});
      return await r.json();
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function showToast(title, sub){
      const toast = document.getElementById('toast');
      toast.innerHTML = `<div style="font-weight:900">${escapeHtml(title)}</div><div class="small">${escapeHtml(sub||'')}</div>`;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove('show'), 1600);
    }
    function addHotspots(chapters){
      const svg = document.getElementById('bg');
      const g = document.getElementById('hotspots');
      if(!svg || !g) return;

      const positions = [
        [320,280],[700,270],[1080,290],
        [420,470],[820,470],
        [1180,520],[300,670],
        [650,680],[980,700],[1250,720]
      ];

      chapters.forEach((ch, idx) => {
        const [x,y] = positions[idx] || [240 + idx*90, 320 + idx*40];
        const ns = "http://www.w3.org/2000/svg";
        const grp = document.createElementNS(ns, "g");
        grp.setAttribute("class","hot");
        grp.setAttribute("tabindex","0");
        grp.dataset.target = ch.file;
        grp.dataset.title = ch.title;
        grp.dataset.sub = ch.subtitle;

        const ring = document.createElementNS(ns,"circle");
        ring.setAttribute("class","ring");
        ring.setAttribute("cx", x); ring.setAttribute("cy", y); ring.setAttribute("r", 54);
        ring.setAttribute("fill","rgba(214,181,91,.14)");
        ring.setAttribute("filter","url(#hotGlow)");

        const stroke = document.createElementNS(ns,"circle");
        stroke.setAttribute("cx", x); stroke.setAttribute("cy", y); stroke.setAttribute("r", 46);
        stroke.setAttribute("fill","none");
        stroke.setAttribute("stroke","rgba(214,181,91,.80)");
        stroke.setAttribute("stroke-width","4");

        const label = document.createElementNS(ns,"text");
        label.setAttribute("class","label ink");
        label.setAttribute("x", x+70);
        label.setAttribute("y", y+10);
        label.textContent = `CH ${(idx+1).toString().padStart(2,'0')}`;

        grp.appendChild(ring); grp.appendChild(stroke); grp.appendChild(label);

        grp.addEventListener('click', ()=> window.location.href = grp.dataset.target);
        grp.addEventListener('mouseenter', ()=> showToast(grp.dataset.title, grp.dataset.sub));
        grp.addEventListener('focus', ()=> showToast(grp.dataset.title, grp.dataset.sub));
        grp.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); window.location.href = grp.dataset.target; } });

        g.appendChild(grp);
      });
    }

    (async ()=>{ const m = await loadManifest(); addHotspots(m.chapters || []); })();
  </script>
</body>
</html>
